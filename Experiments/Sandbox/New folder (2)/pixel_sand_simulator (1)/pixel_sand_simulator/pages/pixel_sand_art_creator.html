<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pixel Sand Art Creator</title>
    <link rel="stylesheet" href="../css/main.css" />
    <link rel="icon" href="https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=64&auto=format&fit=crop" type="image/x-icon" />
    <style>
        /* Enhanced pixel art specific styles */
        #sandbox {
            cursor: crosshair;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            border: 2px solid var(--glass-border);
            border-radius: 8px;
        }
        
        .tool-active {
            background: var(--color-primary) !important;
            color: #0f172a !important;
        }
        
        .sidebar {
            width: 280px;
            backdrop-filter: blur(20px);
            background: rgba(30, 41, 59, 0.95);
            border-right: 1px solid var(--glass-border);
        }
        
        .light-theme .sidebar {
            background: rgba(248, 250, 252, 0.95);
        }
        
        .color-swatch {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 150ms ease-out;
        }
        
        .color-swatch:hover {
            transform: scale(1.1);
            border-color: var(--color-primary);
        }
        
        .color-swatch.active {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(17, 208, 186, 0.3);
        }
        
        .grid-size-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: var(--color-surface);
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all 150ms ease-out;
        }
        
        .grid-size-btn:hover {
            background: var(--color-primary);
            color: #0f172a;
        }
        
        .grid-size-btn.active {
            background: var(--color-primary);
            color: #0f172a;
        }
        
        .brush-preview {
            width: 40px;
            height: 40px;
            border: 1px solid var(--glass-border);
            border-radius: 4px;
            background: var(--color-surface);
            position: relative;
            overflow: hidden;
        }
        
        .brush-preview-dot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--color-primary);
            border-radius: 50%;
            transition: all 150ms ease-out;
        }
        
        .light-theme {
            --color-background: #f8fafc;
            --color-surface: #e2e8f0;
            --color-text-primary: #0f172a;
            --color-text-secondary: #475569;
            --glass-border: rgba(71, 85, 105, 0.2);
            --canvas-bg-light: #ffffff;
            --canvas-bg-dark: #19222a;
        }
        
        .dark-theme {
            --canvas-bg-light: #ffffff;
            --canvas-bg-dark: #19222a;
        }
        
        .zoom-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(30, 41, 59, 0.9);
            color: var(--color-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            opacity: 0.1;
        }
        
        .recent-colors {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        
        .recent-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid var(--glass-border);
            transition: all 150ms ease-out;
        }
        
        .recent-color:hover {
            transform: scale(1.1);
        }
    </style>
<script type="module" src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Fpixelsand1533back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.5"></script>
</head>
<body class="dark-theme overflow-hidden">
    <div class="flex h-screen bg-background">
        <!-- Left Sidebar -->
        <div class="sidebar flex flex-col">
            <!-- Header -->
            <div class="p-6 border-b border-glass-border">
                <h1 class="text-xl font-semibold text-primary mb-2">Pixel Sand Art</h1>
                <p class="text-sm text-secondary">Create detailed pixel art with sand physics</p>
            </div>
            
            <!-- Tools Section -->
            <div class="p-4 border-b border-glass-border">
                <h3 class="text-sm font-medium text-primary mb-3">Tools</h3>
                <div class="space-y-2">
                    <button id="sand-tool" class="tool-active w-full flex items-center gap-3 p-3 rounded-xl transition">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <circle cx="8" cy="8" r="1"/>
                            <circle cx="12" cy="6" r="1"/>
                            <circle cx="16" cy="8" r="1"/>
                            <circle cx="6" cy="12" r="1"/>
                            <circle cx="10" cy="10" r="1"/>
                            <circle cx="14" cy="12" r="1"/>
                        </svg>
                        <span class="text-sm">Sand Brush</span>
                    </button>
                    <button id="color-tool" class="bg-surface text-primary w-full flex items-center gap-3 p-3 rounded-xl transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4z"/>
                        </svg>
                        <span class="text-sm">Color Brush</span>
                    </button>
                    <button id="erase-tool" class="bg-surface text-primary w-full flex items-center gap-3 p-3 rounded-xl transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7"/>
                        </svg>
                        <span class="text-sm">Eraser</span>
                    </button>
                </div>
            </div>
            
            <!-- Brush Settings -->
            <div class="p-4 border-b border-glass-border">
                <h3 class="text-sm font-medium text-primary mb-3">Brush Settings</h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-sm text-secondary mb-2 block">Size: <span id="brush-size-label" class="text-primary font-mono">3</span></label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="brush-size" min="1" max="20" value="3" class="flex-1 accent-primary" />
                            <div class="brush-preview">
                                <div class="brush-preview-dot" id="brush-preview"></div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm text-secondary mb-2 block">Zoom: <span id="zoom-label" class="text-primary font-mono">4x</span></label>
                        <input type="range" id="zoom" min="1" max="8" value="4" class="w-full accent-primary" />
                    </div>
                </div>
            </div>
            
            <!-- Color Palette -->
            <div class="p-4 border-b border-glass-border">
                <h3 class="text-sm font-medium text-primary mb-3">Colors</h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-sm text-secondary mb-2 block">Current Color</label>
                        <input type="color" id="color-picker" value="#11d0ba" class="w-full h-10 rounded-lg border border-glass-border" />
                    </div>
                    <div>
                        <label class="text-sm text-secondary mb-2 block">Preset Colors</label>
                        <div class="grid grid-cols-4 gap-2">
                            <div class="color-swatch active" style="background-color: #11d0ba;" data-color="#11d0ba"></div>
                            <div class="color-swatch" style="background-color: #ef4444;" data-color="#ef4444"></div>
                            <div class="color-swatch" style="background-color: #10b981;" data-color="#10b981"></div>
                            <div class="color-swatch" style="background-color: #f59e0b;" data-color="#f59e0b"></div>
                            <div class="color-swatch" style="background-color: #8b5cf6;" data-color="#8b5cf6"></div>
                            <div class="color-swatch" style="background-color: #06b6d4;" data-color="#06b6d4"></div>
                            <div class="color-swatch" style="background-color: #f97316;" data-color="#f97316"></div>
                            <div class="color-swatch" style="background-color: #84cc16;" data-color="#84cc16"></div>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm text-secondary mb-2 block">Recent Colors</label>
                        <div id="recent-colors" class="recent-colors min-h-[24px]">
                            <!-- Recent colors will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="p-4 mt-auto space-y-3">
                <div class="flex gap-2">
                    <button id="theme-btn" class="flex-1 bg-surface text-primary p-3 rounded-xl flex items-center justify-center gap-2 transition hover:bg-primary hover:text-background">
                        <span id="theme-icon">🌙</span>
                        <span class="text-sm">Theme</span>
                    </button>
                    <button id="clear-btn" class="flex-1 bg-surface text-primary p-3 rounded-xl flex items-center justify-center gap-2 transition hover:bg-primary hover:text-background">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7"/>
                        </svg>
                        <span class="text-sm">Clear</span>
                    </button>
                </div>
                <button id="save-btn" class="w-full bg-primary text-background p-3 rounded-xl flex items-center justify-center gap-2 transition hover:opacity-90">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span class="text-sm font-medium">Export PNG</span>
                </button>
                <div class="text-xs text-secondary space-y-1">
                    <div><kbd class="bg-surface px-2 py-1 rounded text-xs">Space</kbd> Pause/Resume</div>
                    <div><kbd class="bg-surface px-2 py-1 rounded text-xs">C</kbd> Clear • <kbd class="bg-surface px-2 py-1 rounded text-xs">S</kbd> Save • <kbd class="bg-surface px-2 py-1 rounded text-xs">T</kbd> Theme</div>
                </div>
            </div>
        </div>
        
        <!-- Main Canvas Area -->
        <div class="flex-1 relative">
            <canvas id="sandbox" class="w-full h-full"></canvas>
            <div class="zoom-indicator" id="zoom-indicator">4x</div>
            <canvas id="grid-overlay" class="grid-overlay"></canvas>
        </div>
    </div>

    <script>
        // --- Variables and Setup ---
        const canvas = document.getElementById("sandbox");
        const ctx = canvas.getContext("2d");
        const toolSelect = document.getElementById('tool');
        const colorPicker = document.getElementById('color-picker');
        const brushSizeInput = document.getElementById('brush-size');
        const brushSizeLabel = document.getElementById('brush-size-label');
        const clearBtn = document.getElementById('clear-btn');
        const saveBtn = document.getElementById('save-btn');
        const zoomInput = document.getElementById('zoom');
        const zoomLabel = document.getElementById('zoom-label');
        const themeBtn = document.getElementById('theme-btn');
        const themeIcon = document.getElementById('theme-icon');
        const zoomIndicator = document.getElementById('zoom-indicator');
        const brushPreview = document.getElementById('brush-preview');
        const recentColorsContainer = document.getElementById('recent-colors');

        // --- Settings ---
        const BASE_PARTICLE_SIZE = 12; // Larger pixel size for pixel art
        let zoom = parseInt(zoomInput.value); // 1x, 2x, etc.

        // --- State ---
        let brushSize = parseInt(brushSizeInput.value);
        let selectedColor = colorPicker.value;
        let tool = 'sand'; // 'sand', 'erase', 'color'
        let paused = false, isMousePressed = false;
        let grid = [], gridWidth, gridHeight, particleColors = [];
        let needsResize = false;
        let isDark = true; // default theme
        let recentColors = [];

        // --- THEME ---
        function setTheme(dark) {
            isDark = dark;
            document.body.classList.toggle('light-theme', !dark);
            document.body.classList.toggle('dark-theme', dark);
            themeIcon.textContent = dark ? "🌙" : "🌞";
            draw();
        }

        // Try to use system theme preference
        const savedTheme = localStorage.getItem('pixel-sand-theme');
        if (savedTheme === 'dark') setTheme(true);
        else if (savedTheme === 'light') setTheme(false);
        else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) setTheme(false);

        themeBtn.addEventListener('click', () => {
            setTheme(!isDark);
            localStorage.setItem('pixel-sand-theme', isDark ? 'dark' : 'light');
        });

        // --- Color Management ---
        function addToRecentColors(color) {
            if (!recentColors.includes(color)) {
                recentColors.unshift(color);
                if (recentColors.length > 8) {
                    recentColors = recentColors.slice(0, 8);
                }
                updateRecentColorsDisplay();
            }
        }

        function updateRecentColorsDisplay() {
            recentColorsContainer.innerHTML = '';
            recentColors.forEach(color => {
                const colorDiv = document.createElement('div');
                colorDiv.className = 'recent-color';
                colorDiv.style.backgroundColor = color;
                colorDiv.addEventListener('click', () => selectColor(color));
                recentColorsContainer.appendChild(colorDiv);
            });
        }

        function selectColor(color) {
            selectedColor = color;
            colorPicker.value = color;
            
            // Update active swatch
            document.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.classList.remove('active');
            });
            
            const matchingSwatch = document.querySelector(`[data-color="${color}"]`);
            if (matchingSwatch) {
                matchingSwatch.classList.add('active');
            }
            
            addToRecentColors(color);
        }

        // --- Brush Preview ---
        function updateBrushPreview() {
            const size = Math.min(30, Math.max(4, brushSize * 2));
            brushPreview.style.width = `${size}px`;
            brushPreview.style.height = `${size}px`;
        }

        // --- Resize and Grid ---
        function resizeCanvas(keepData = false) {
            const particleSize = BASE_PARTICLE_SIZE * zoom;
            const sidebar = document.querySelector('.sidebar');
            const availableWidth = window.innerWidth - sidebar.offsetWidth;
            const availableHeight = window.innerHeight;
            
            gridWidth = Math.floor(availableWidth / particleSize);
            gridHeight = Math.floor(availableHeight / particleSize);
            
            canvas.width = gridWidth * particleSize;
            canvas.height = gridHeight * particleSize;
            
            if (keepData && grid.length && particleColors.length) {
                grid.length = gridHeight;
                particleColors.length = gridHeight;
                for (let y = 0; y < gridHeight; y++) {
                    if (!grid[y]) grid[y] = Array(gridWidth).fill(0);
                    else grid[y].length = gridWidth;
                    if (!particleColors[y]) particleColors[y] = Array(gridWidth).fill(null);
                    else particleColors[y].length = gridWidth;
                }
            } else {
                grid = Array.from({ length: gridHeight }, () => Array(gridWidth).fill(0));
                particleColors = Array.from({ length: gridHeight }, () => Array(gridWidth).fill(null));
            }
            
            needsResize = false;
            draw();
        }

        window.addEventListener("resize", () => { needsResize = true; });

        // --- Sand Simulation ---
        function updateSand() {
            for (let y = gridHeight - 2; y >= 0; y--) {
                let xOrder = [];
                for (let x = 0; x < gridWidth; x++) xOrder.push(x);
                if (Math.random() < 0.5) xOrder.reverse();
                for (const x of xOrder) {
                    if (grid[y][x] === 1) {
                        // Down
                        if (y + 1 < gridHeight && grid[y + 1][x] === 0) {
                            grid[y + 1][x] = 1; grid[y][x] = 0;
                            particleColors[y + 1][x] = particleColors[y][x]; particleColors[y][x] = null;
                        } else {
                            // Diagonals (random order to avoid bias)
                            let dirs = Math.random() < 0.5 ? [-1, 1] : [1, -1];
                            for (const dx of dirs) {
                                if (
                                    x + dx >= 0 && x + dx < gridWidth &&
                                    y + 1 < gridHeight && grid[y + 1][x + dx] === 0
                                ) {
                                    grid[y + 1][x + dx] = 1;
                                    grid[y][x] = 0;
                                    particleColors[y + 1][x + dx] = particleColors[y][x];
                                    particleColors[y][x] = null;
                                    break;
                                }
                            }
                        }
                    }
                }
            }
        }

        // --- Drawing ---
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Fill canvas background to match theme for saving
            ctx.fillStyle = isDark ? 
                getComputedStyle(document.body).getPropertyValue('--canvas-bg-dark')?.trim() || "#19222a" :
                getComputedStyle(document.body).getPropertyValue('--canvas-bg-light')?.trim() || "#ffffff";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const particleSize = BASE_PARTICLE_SIZE * zoom;
            for (let y = 0; y < gridHeight; y++) {
                for (let x = 0; x < gridWidth; x++) {
                    if (grid[y][x] === 1) {
                        ctx.fillStyle = particleColors[y][x] || selectedColor;
                        ctx.fillRect(x * particleSize, y * particleSize, particleSize, particleSize);
                    }
                }
            }
        }

        // --- Sand Placement/Brushes ---
        function canvasToGrid(e) {
            const rect = canvas.getBoundingClientRect();
            const particleSize = BASE_PARTICLE_SIZE * zoom;
            const x = Math.floor((e.clientX - rect.left) / particleSize);
            const y = Math.floor((e.clientY - rect.top) / particleSize);
            return { x, y };
        }

        function paintAt(x, y) {
            for (let dy = -brushSize + 1; dy < brushSize; dy++) {
                for (let dx = -brushSize + 1; dx < brushSize; dx++) {
                    if (dx * dx + dy * dy <= brushSize * brushSize) {
                        let nx = x + dx, ny = y + dy;
                        if (nx >= 0 && nx < gridWidth && ny >= 0 && ny < gridHeight) {
                            if (tool === 'sand') {
                                grid[ny][nx] = 1;
                                particleColors[ny][nx] = selectedColor;
                            } else if (tool === 'erase') {
                                grid[ny][nx] = 0;
                                particleColors[ny][nx] = null;
                            } else if (tool === 'color' && grid[ny][nx] === 1) {
                                particleColors[ny][nx] = selectedColor;
                            }
                        }
                    }
                }
            }
        }

        canvas.addEventListener("mousedown", (e) => {
            isMousePressed = true;
            const {x, y} = canvasToGrid(e);
            paintAt(x, y);
            draw();
        });
        document.addEventListener("mouseup", () => { isMousePressed = false; });
        canvas.addEventListener("mousemove", (e) => {
            if (!isMousePressed) return;
            const {x, y} = canvasToGrid(e);
            paintAt(x, y);
            draw();
        });

        // Support touch events for mobile
        canvas.addEventListener('touchstart', function(e) {
            isMousePressed = true;
            const touch = e.touches[0];
            const {x, y} = canvasToGrid(touch);
            paintAt(x, y);
            draw();
            e.preventDefault();
        }, {passive: false});
        canvas.addEventListener('touchmove', function(e) {
            if (!isMousePressed) return;
            const touch = e.touches[0];
            const {x, y} = canvasToGrid(touch);
            paintAt(x, y);
            draw();
            e.preventDefault();
        }, {passive: false});
        document.addEventListener('touchend', () => { isMousePressed = false; });

        // --- Tool Selection ---
        function selectTool(newTool) {
            tool = newTool;
            
            // Update tool buttons
            document.querySelectorAll('[id$="-tool"]').forEach(btn => {
                btn.classList.remove('tool-active');
                btn.classList.add('bg-surface', 'text-primary');
            });
            
            const activeBtn = document.getElementById(newTool + '-tool');
            if (activeBtn) {
                activeBtn.classList.add('tool-active');
                activeBtn.classList.remove('bg-surface', 'text-primary');
            }
        }

        // --- Controls ---
        colorPicker.addEventListener('input', e => { 
            selectColor(e.target.value);
        });

        brushSizeInput.addEventListener('input', e => {
            brushSize = parseInt(e.target.value);
            brushSizeLabel.textContent = brushSize;
            updateBrushPreview();
        });

        clearBtn.addEventListener('click', () => {
            grid = Array.from({ length: gridHeight }, () => Array(gridWidth).fill(0));
            particleColors = Array.from({ length: gridHeight }, () => Array(gridWidth).fill(null));
            draw();
        });

        saveBtn.addEventListener('click', () => {
            draw();
            canvas.toBlob(blob => {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'pixel_sand_art.png';
                a.click();
            });
        });

        zoomInput.addEventListener('input', e => {
            zoom = parseInt(e.target.value);
            zoomLabel.textContent = zoom + 'x';
            zoomIndicator.textContent = zoom + 'x';
            resizeCanvas(true);
        });

        // --- Tool Event Listeners ---
        document.getElementById('sand-tool').addEventListener('click', () => selectTool('sand'));
        document.getElementById('color-tool').addEventListener('click', () => selectTool('color'));
        document.getElementById('erase-tool').addEventListener('click', () => selectTool('erase'));

        // --- Color Swatch Event Listeners ---
        document.querySelectorAll('.color-swatch[data-color]').forEach(swatch => {
            swatch.addEventListener('click', () => {
                selectColor(swatch.dataset.color);
            });
        });

        // --- Keyboard Shortcuts ---
        document.addEventListener('keydown', e => {
            if (e.code === 'Space') {
                paused = !paused;
                e.preventDefault();
            }
            else if (e.key.toLowerCase() === 'c') {
                clearBtn.click();
            } else if (e.key.toLowerCase() === 's') {
                e.preventDefault();
                saveBtn.click();
            } else if (e.key.toLowerCase() === 't') {
                themeBtn.click();
            }
        });

        // --- Initialize defaults ---
        colorPicker.value = "#11d0ba";
        selectedColor = "#11d0ba";
        addToRecentColors("#11d0ba");

        // --- Main Loop ---
        function step() {
            if (needsResize) resizeCanvas(true);
            if (!paused) updateSand();
            draw();
            requestAnimationFrame(step);
        }

        // --- Initialize ---
        brushSizeLabel.textContent = brushSize;
        zoomLabel.textContent = zoom + 'x';
        zoomIndicator.textContent = zoom + 'x';
        updateBrushPreview();
        resizeCanvas();
        step();
    </script>
<script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
</body>
</html>